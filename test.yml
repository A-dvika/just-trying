# .gitlab-ci.yml

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  GLOBAL CONFIG
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stages:
  - build
  - clmscan
  - upload_assets
  - site_deploy
  - environment

# use your internal Node imageâ€”no pull (must be pre-cached on your runners)
image:
  name: registry.aws.site.gs.com:443/dx/js-eng/nodejs-container-images/ubi-rhel20-node20-chrome:current
  pull_policy: never

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - node_modules/
    - .vite/

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  TEMPLATE JOBS
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
.upload_assets: &upload_assets
  stage: upload_assets
  tags: [default, linux, kubernetes]
  script:
    - echo -e "\nğŸ“¤ Uploading static assets from $STATIC_ASSETS"
    - ./scripts/upload-assets.sh "$STATIC_ASSETS"

.site_deploy: &site_deploy
  stage: site_deploy
  tags: [default, linux, kubernetes]
  script:
    - echo -e "\nğŸš€ Deploying to environment '$envIdentifier' (DID=$DID)"
    - ./scripts/deploy-site.sh \
        --config "$siteDeployConfigPath" \
        --did "$DID" \
        --env "$envIdentifier"

.create_environment: &create_env
  stage: environment
  tags: [default, linux, kubernetes]
  script:
    - echo -e "\nğŸŒ Creating environment '$environment[name]'"
    - ./scripts/environment-create.sh --id "$envIdentifier" --name "$environment[name]"

.stop_environment: &stop_env
  stage: environment
  tags: [default, linux, kubernetes]
  script:
    - echo -e "\nğŸ›‘ Stopping environment '$environment[name]'"
    - ./scripts/environment-stop.sh --id "$envIdentifier" --name "$environment[name]"


#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  1) Build â†’ lint, test, bundle, pack
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
build_frontend:
  stage: build
  tags: [default, linux, kubernetes]
  script:
    - cd frontend
    - echo -e "\n\033[1;33mâ¤ Installing dependencies (Node $(node -v))...\033[0m"
    - npm ci
    - echo -e "\n\033[1;34m=== ğŸ” Linting Source Code ===\033[0m"
    - npm run lint
    - echo -e "\n\033[1;34m=== ğŸ§ª Running Tests ===\033[0m"
    - npm run test -- --coverage --reporter jest-junit
    - echo -e "\n\033[1;34m=== ğŸ“¦ Building Production Bundle ===\033[0m"
    - npm run build
    - echo -e "\033[1;32mâœ” Build & tests complete!\033[0m"
    - npm pack
  artifacts:
    paths:
      - frontend/dist
      - frontend/junit-report.xml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^release-frontend-.*$/'
      changes:
        - frontend/**/*


#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  2) CLM Scan (needs build)
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
request_clmscan_frontend:
  stage: clmscan
  tags: [default, linux, kubernetes]
  image: gitlab.registry.docker.site.gs.com:443/dx/sdlc-tools/gitlab-clm-plugin/gitlab-clm-plugin:current
  script:
    - /opt/clm/request-clmscan.sh "$CI_PROJECT_DIR/frontend/dist"
  needs:
    - build_frontend
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^release-frontend-.*$/'
      changes:
        - frontend/**/*


#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  3) Upload Static Assets
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
static_assets_frontend:
  variables:
    STATIC_ASSETS: frontend/dist

upload_assets_frontend:
  <<: *upload_assets
  needs:
    - build_frontend
    - request_clmscan_frontend
  rules:
    - if: '$CI_COMMIT_REF_NAME =~ /^release-frontend-.*$/'
      changes:
        - frontend/**/*


#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  4) Site Deploy (feature & master branches)
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
site_deploy_feature_frontend:
  <<: *site_deploy
  variables:
    DID: 123456                # your DEV DID
    siteDeployConfigPath: "./frontend/siteDeployConfig.json"
    envIdentifier: "frontend-feature-branch"
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "master"'
      changes:
        - frontend/**/*
  when: manual
  needs:
    - upload_assets_frontend

site_deploy_master_frontend:
  <<: *site_deploy
  variables:
    DID: 123456                # your PROD DID
    siteDeployConfigPath: "./frontend/siteDeployConfig.json"
    envIdentifier: "frontend-master-branch"
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - frontend/**/*
  needs:
    - upload_assets_frontend


#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  5) Dynamic Environments (create & stop)
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
environment_feature_frontend:
  <<: *create_env
  variables:
    envIdentifier: "frontend-feature-branch"
  environment:
    name: feature/frontend/$CI_COMMIT_REF_NAME
    on_stop: stop_environment_feature_frontend
  rules:
    - if: '$CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != "master"'
      changes:
        - frontend/**/*

stop_environment_feature_frontend:
  <<: *stop_env
  variables:
    envIdentifier: "frontend-feature-branch"
  environment:
    name: feature/frontend/$CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

environment_master_frontend:
  <<: *create_env
  variables:
    envIdentifier: "frontend-master-branch"
  environment:
    name: master/frontend/$CI_COMMIT_REF_NAME
    on_stop: stop_environment_master_frontend
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - frontend/**/*

stop_environment_master_frontend:
  <<: *stop_env
  variables:
    envIdentifier: "frontend-master-branch"
  environment:
    name: master/frontend/$CI_COMMIT_REF_NAME
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - frontend/**/*
